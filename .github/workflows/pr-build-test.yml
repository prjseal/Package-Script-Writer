name: PR - Build and Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean solution
        shell: pwsh
        run: |
          Write-Host "Cleaning solution..." -ForegroundColor Cyan
          dotnet clean ./src/PSW.sln --configuration Release

      - name: Restore dependencies
        shell: pwsh
        run: |
          Write-Host "Restoring dependencies..." -ForegroundColor Cyan
          dotnet restore ./src/PSW.sln

      - name: Build solution
        shell: pwsh
        run: |
          Write-Host "Building solution..." -ForegroundColor Cyan
          dotnet build ./src/PSW.sln --configuration Release --no-restore

      - name: Install Playwright
        shell: pwsh
        run: |
          Write-Host "Installing Playwright..." -ForegroundColor Cyan
          npm init -y
          npm install --save-dev playwright
          npx playwright install chromium

      - name: Start website
        shell: pwsh
        run: |
          Write-Host "Starting website in background..." -ForegroundColor Cyan
          $env:ASPNETCORE_ENVIRONMENT = "Development"

          $logFile = "site.log"
          $errFile = "site.err"

          $process = Start-Process -FilePath "dotnet" `
            -ArgumentList "run --project ./src/PSW/PSW.csproj" `
            -RedirectStandardOutput $logFile `
            -RedirectStandardError $errFile `
            -NoNewWindow `
            -PassThru

          Write-Host "Site process started with PID: $($process.Id)" -ForegroundColor Green

          # Store process ID for cleanup
          $process.Id | Out-File -FilePath "site-process-id.txt"

          # Wait for site to start and extract URL from log
          $startTime = Get-Date
          $timeoutSeconds = 180
          $siteStarted = $false
          $siteUrl = $null

          Write-Host "Waiting for site to start (timeout: ${timeoutSeconds}s)..." -ForegroundColor Yellow

          while (-not $siteStarted) {
              if ((Get-Date) - $startTime -gt (New-TimeSpan -Seconds $timeoutSeconds)) {
                  Write-Host "Timeout reached! Site failed to start." -ForegroundColor Red
                  if (-not $process.HasExited) {
                      Stop-Process -Id $process.Id -Force
                  }
                  Get-Content $logFile -ErrorAction SilentlyContinue
                  Get-Content $errFile -ErrorAction SilentlyContinue
                  exit 1
              }

              if (Test-Path $logFile) {
                  $logContent = Get-Content $logFile -Raw

                  # Check if site is listening on HTTPS
                  if ($logContent -match "Now listening on:\s*(https://[^\s]+)") {
                      $siteUrl = $matches[1]
                      Write-Host "Site detected at: $siteUrl" -ForegroundColor Yellow

                      # Check if process is still running
                      if ($process.HasExited) {
                          Write-Host "ERROR: Site process has exited!" -ForegroundColor Red
                          Write-Host "Exit code: $($process.ExitCode)" -ForegroundColor Red
                          Write-Host "`nStdout log:" -ForegroundColor Yellow
                          Get-Content $logFile -ErrorAction SilentlyContinue
                          Write-Host "`nStderr log:" -ForegroundColor Yellow
                          Get-Content $errFile -ErrorAction SilentlyContinue
                          exit 1
                      }

                      # Wait and verify site is actually accepting connections
                      Write-Host "Verifying site is accepting connections..." -ForegroundColor Yellow
                      $verifyAttempts = 0
                      $maxVerifyAttempts = 15
                      $connectionSuccess = $false

                      while ($verifyAttempts -lt $maxVerifyAttempts -and -not $connectionSuccess) {
                          Start-Sleep -Seconds 2
                          $verifyAttempts++

                          # Check process hasn't exited
                          if ($process.HasExited) {
                              Write-Host "ERROR: Site process exited during startup!" -ForegroundColor Red
                              Write-Host "Exit code: $($process.ExitCode)" -ForegroundColor Red
                              Write-Host "`nStdout log:" -ForegroundColor Yellow
                              Get-Content $logFile -ErrorAction SilentlyContinue
                              Write-Host "`nStderr log:" -ForegroundColor Yellow
                              Get-Content $errFile -ErrorAction SilentlyContinue
                              exit 1
                          }

                          # Try to connect using Test-NetConnection (more reliable than web request)
                          try {
                              $uri = [System.Uri]$siteUrl
                              $port = $uri.Port
                              $host = $uri.Host

                              Write-Host "Attempt $verifyAttempts/$maxVerifyAttempts - Testing connection to ${host}:${port}..." -ForegroundColor Yellow

                              # Use .NET TcpClient for connection test (works better in CI)
                              $tcpClient = New-Object System.Net.Sockets.TcpClient
                              $tcpClient.ReceiveTimeout = 2000
                              $tcpClient.SendTimeout = 2000
                              $asyncResult = $tcpClient.BeginConnect($host, $port, $null, $null)
                              $waitHandle = $asyncResult.AsyncWaitHandle

                              if ($waitHandle.WaitOne(2000)) {
                                  $tcpClient.EndConnect($asyncResult)
                                  $connectionSuccess = $true
                                  Write-Host "Connection successful!" -ForegroundColor Green
                              } else {
                                  Write-Host "Connection timeout, retrying..." -ForegroundColor Yellow
                              }
                              $tcpClient.Close()
                          } catch {
                              Write-Host "Connection failed: $($_.Exception.Message), retrying..." -ForegroundColor Yellow
                          }
                      }

                      if (-not $connectionSuccess) {
                          Write-Host "ERROR: Could not establish connection to site after $maxVerifyAttempts attempts!" -ForegroundColor Red
                          Write-Host "`nFinal log output:" -ForegroundColor Yellow
                          Get-Content $logFile -ErrorAction SilentlyContinue
                          Write-Host "`nError output:" -ForegroundColor Yellow
                          Get-Content $errFile -ErrorAction SilentlyContinue
                          if (-not $process.HasExited) {
                              Stop-Process -Id $process.Id -Force
                          }
                          exit 1
                      }

                      $siteStarted = $true
                      Write-Host "Site is ready and accepting connections at: $siteUrl" -ForegroundColor Green

                      # Store the URL for later steps
                      $siteUrl | Out-File -FilePath "site-url.txt"
                      break
                  }
              }

              Start-Sleep -Seconds 2
          }

      - name: Generate Playwright test script
        shell: pwsh
        run: |
          Write-Host "Generating Playwright test script..." -ForegroundColor Cyan
          ./.github/workflows/powershell/Write-PlaywrightTestScript.ps1 -OutputPath "test-site.js"

      - name: Run Playwright tests
        shell: pwsh
        run: |
          Write-Host "Running Playwright tests..." -ForegroundColor Cyan
          $siteUrl = Get-Content "site-url.txt"
          Write-Host "Testing site at: $siteUrl" -ForegroundColor Cyan

          # Display recent log output before running tests
          Write-Host "`nRecent site log output:" -ForegroundColor Yellow
          Get-Content "site.log" -Tail 20 -ErrorAction SilentlyContinue

          $env:SITE_URL = $siteUrl
          node test-site.js

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-screenshots-${{ github.event.pull_request.number }}
          path: screenshots/*.png
          if-no-files-found: warn

      - name: Stop website
        if: always()
        shell: pwsh
        run: |
          Write-Host "Stopping website..." -ForegroundColor Cyan
          if (Test-Path "site-process-id.txt") {
              $processId = Get-Content "site-process-id.txt"
              Stop-Process -Id $processId -Force -ErrorAction SilentlyContinue
              Write-Host "Website process stopped" -ForegroundColor Green
          }

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Build and Test Summary" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "PR Number: ${{ github.event.pull_request.number }}" -ForegroundColor White
          Write-Host "Branch: ${{ github.head_ref }}" -ForegroundColor White
          Write-Host "Actor: ${{ github.actor }}" -ForegroundColor White
          Write-Host "Repository: ${{ github.repository }}" -ForegroundColor White
          Write-Host "================================================" -ForegroundColor Cyan
