name: PR - Website - Build and Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  website-build-and-test:
    runs-on: ubuntu-latest
    if: github.repository == 'prjseal/Package-Script-Writer'

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore ./src/PSW.sln

      - name: Build solution
        run: dotnet build ./src/PSW.sln --configuration Release --no-restore /p:RunPreBuildEvent=false 2>&1 | tee build-output.log

      - name: Run integration tests
        run: dotnet test ./src/PSW.IntegrationTests/PSW.IntegrationTests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" 2>&1 | tee test-output.log

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ github.run_number }}
          path: '**/test-results.trx'
          if-no-files-found: warn

      - name: Generate Summary
        if: always()
        shell: bash
        run: |
          # Parse build output for errors and warnings
          if [ -f build-output.log ]; then
            warning_count=$(grep -c "warning [A-Z0-9]*:" build-output.log || echo "0")
            error_count=$(grep -c "error [A-Z0-9]*:" build-output.log || echo "0")
          else
            warning_count=0
            error_count=0
          fi

          # Parse test output
          # Format: "Test Run Successful." followed by "Total tests: X", "     Passed: Y", etc.
          if [ -f test-output.log ]; then
            if grep -q "Test Run" test-output.log; then
              # Extract total tests
              test_total=$(grep "Total tests:" test-output.log | grep -oP "Total tests:\s*\K\d+" || echo "0")

              # Extract passed tests
              test_passed=$(grep "Passed:" test-output.log | grep -oP "Passed:\s*\K\d+" || echo "0")

              # Extract failed tests (may not exist if all passed)
              test_failed=$(grep "Failed:" test-output.log | grep -oP "Failed:\s*\K\d+" || echo "0")

              # Extract skipped tests (may not exist)
              test_skipped=$(grep "Skipped:" test-output.log | grep -oP "Skipped:\s*\K\d+" || echo "0")

              # Determine status
              if grep -q "Test Run Successful" test-output.log; then
                test_status="âœ… Passed"
              elif grep -q "Test Run Failed" test-output.log; then
                test_status="âŒ Failed"
              else
                test_status="âš ï¸ Unknown"
              fi
            else
              test_status="âš ï¸ Unknown"
              test_failed=0
              test_passed=0
              test_skipped=0
              test_total=0
            fi
          else
            test_status="âš ï¸ Unknown"
            test_failed=0
            test_passed=0
            test_skipped=0
            test_total=0
          fi

          # Determine build status
          if [ "$error_count" -gt 0 ]; then
            build_status="âŒ Failed"
          elif [ "$warning_count" -gt 0 ]; then
            build_status="âš ï¸ Warning"
          else
            build_status="âœ… Success"
          fi

          # Create GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸŒ Website Build and Test Summary

          ## Overview
          - **PR Number**: ${{ github.event.pull_request.number }}
          - **Branch**: ${{ github.head_ref }}
          - **Triggered by**: ${{ github.actor }}
          - **Commit**: ${{ github.sha }}

          ## Build Results
          | Metric | Count | Status |
          |--------|-------|--------|
          | Errors | $error_count | $build_status |
          | Warnings | $warning_count | $([ "$warning_count" -gt 0 ] && echo "âš ï¸" || echo "âœ…") |

          ## Integration Test Results
          | Metric | Count |
          |--------|-------|
          | **Status** | **$test_status** |
          | Total | $test_total |
          | Passed | âœ… $test_passed |
          | Failed | âŒ $test_failed |
          | Skipped | â­ï¸ $test_skipped |

          ## Artifacts
          - ðŸ“„ Test results uploaded as artifact: \`integration-test-results-${{ github.run_number }}\`

          ---
          *Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
