name: PackageCliTool - PR Build and Test

on:
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: windows-latest
    if: github.repository == 'prjseal/Package-Script-Writer'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Clean solution
        shell: pwsh
        run: |
          Write-Host "Cleaning PackageCliTool solution..." -ForegroundColor Cyan
          dotnet clean ./src/PackageCliTool.sln --configuration Release

      - name: Restore dependencies
        shell: pwsh
        run: |
          Write-Host "Restoring dependencies..." -ForegroundColor Cyan
          dotnet restore ./src/PackageCliTool.sln

      - name: Build solution
        shell: pwsh
        run: |
          Write-Host "Building PackageCliTool solution..." -ForegroundColor Cyan
          dotnet build ./src/PackageCliTool.sln --configuration Release --no-restore /p:RunPreBuildEvent=false

      - name: Run tests
        shell: pwsh
        run: |
          Write-Host "Running PackageCliTool tests..." -ForegroundColor Cyan
          dotnet test ./src/PackageCliTool.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.event.pull_request.number }}
          path: '**/TestResults/*.trx'
          if-no-files-found: warn

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "PackageCliTool Build and Test Summary" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "PR Number: ${{ github.event.pull_request.number }}" -ForegroundColor White
          Write-Host "Branch: ${{ github.head_ref }}" -ForegroundColor White
          Write-Host "Actor: ${{ github.actor }}" -ForegroundColor White
          Write-Host "Repository: ${{ github.repository }}" -ForegroundColor White
          Write-Host "================================================" -ForegroundColor Cyan
